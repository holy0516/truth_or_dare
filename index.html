<!doctype html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <title>真実か挑戦か｜2人対戦</title>
    <meta name="theme-color" content="#111" />
    <style>
      :root {
        --bg: #0f1115; --panel: #161a22; --text: #e6e8ee; --muted: #98a2b3;
        --accent: #3b82f6; --truth: #10b981; --dare: #ef4444;
      }
      html, body { height: 100%; }
      body { margin: 0; background: var(--bg); color: var(--text);
        font-family: system-ui, -apple-system, Segoe UI, Roboto, "Hiragino Sans", "Noto Sans JP", Arial, sans-serif;
        -webkit-font-smoothing: antialiased; display: grid; place-items: center; }
      .app { width: min(680px, 100vw); min-height: 100vh; box-sizing: border-box;
        padding: env(safe-area-inset-top) 16px env(safe-area-inset-bottom) 16px;
        display: grid; grid-template-rows: auto auto 1fr auto; gap: 12px; }
      header { display: flex; align-items: center; justify-content: space-between; }
      header .title { font-weight: 700; letter-spacing: 0.02em; }
      header .counts { font-size: 12px; color: var(--muted); }

      .setup { background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.08);
        border-radius: 14px; padding: 12px; display: grid; gap: 8px; }
      .row { display: grid; grid-template-columns: 1fr 1fr auto; gap: 8px; }
      input { background: #0f1320; border: 1px solid rgba(255,255,255,.12); color: var(--text);
        padding: 12px; border-radius: 10px; font-size: 16px; }

      .card { background: linear-gradient(180deg, rgba(255,255,255,0.04), rgba(255,255,255,0.02));
        border: 1px solid rgba(255,255,255,0.08); border-radius: 16px; padding: 20px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.35); display: grid; grid-template-rows: auto 1fr auto; gap: 10px; min-height: 42vh; }
      .chip { display: inline-flex; align-items: center; gap: 6px; padding: 4px 10px; border-radius: 999px; font-size: 12px; border: 1px solid rgba(255,255,255,0.12) }
      .chip.truth { color: var(--truth); border-color: color-mix(in oklab, var(--truth) 60%, transparent); }
      .chip.dare { color: var(--dare); border-color: color-mix(in oklab, var(--dare) 60%, transparent); }
      #prompt { font-size: clamp(20px, 4.8vw, 28px); line-height: 1.5; }

      .actions { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
      .hint { font-size: 14px; color: var(--muted); margin-top: 4px; }
      button { -webkit-tap-highlight-color: transparent; appearance: none; border: none; cursor: pointer;
        background: var(--accent); color: white; font-weight: 700; padding: 16px; border-radius: 14px; font-size: 16px; box-shadow: 0 8px 20px rgba(59,130,246,0.32);
        transition: transform .05s ease, filter .2s ease; }
      button:active { transform: translateY(1px) scale(0.99); }
      .secondary { background: #252b39; color: var(--text); box-shadow: none; }
      .truthBtn { background: var(--truth); box-shadow: 0 8px 20px rgba(16,185,129,.28); }
      .dareBtn { background: var(--dare); box-shadow: 0 8px 20px rgba(239,68,68,.28); }

      .toolbar { display: flex; gap: 8px; }
      .history { display: grid; gap: 6px; max-height: 32vh; overflow: auto; padding-right: 4px; }
      .history-item { font-size: 13px; color: var(--muted); display: grid; grid-template-columns: auto auto 1fr; gap: 8px; align-items: baseline; }
      .dot { width: 8px; height: 8px; border-radius: 50%; margin-top: 6px; }
      .dot.truth { background: var(--truth); } .dot.dare { background: var(--dare); }
      .turn { font-size: 13px; color: var(--muted); }

      footer { display: flex; align-items: center; justify-content: space-between; color: var(--muted); font-size: 12px; }
      a { color: var(--text); opacity: .9; }
      @media (max-width: 420px) { .actions { grid-template-columns: 1fr; } .row { grid-template-columns: 1fr; } }
    </style>
  </head>
  <body>
    <main class="app">
      <header>
        <div class="title">真実か挑戦か</div>
        <div class="toolbar">
          <button id="btnSecret" class="secondary" style="padding:8px 12px;font-size:13px;">裏モードOFF</button>
          <div class="counts" id="counts">残り: -</div>
        </div>
      </header>

      <section class="setup" id="setup" style="display:grid;">
        <div class="row">
          <input id="p1" placeholder="プレイヤー1の名前" inputmode="text" />
          <input id="p2" placeholder="プレイヤー2の名前" inputmode="text" />
          <button id="btnStart">開始</button>
        </div>
        <div class="turn" id="turnInfo">名前を入力して「開始」</div>
      </section>

      <section id="game" style="display:none;">
        <section class="card" aria-live="polite" aria-atomic="true">
          <div>
            <span id="typeChip" class="chip">カード未選択</span>
            <span class="turn" id="currentPlayer"></span>
          </div>
          <div id="prompt">プレイヤーが「真実」か「挑戦」を選んでください</div>
          <div id="nextHint" class="hint"></div>
          <div class="actions">
            <button id="btnTruth" class="truthBtn">真実をひく</button>
            <button id="btnDare" class="dareBtn">挑戦をひく</button>
          </div>
          <div class="actions">
            <button id="btnSkip" class="secondary">スキップ</button>
            <button id="btnReset" class="secondary">リセット</button>
          </div>
        </section>
        <section>
          <div class="history" id="history"></div>
        </section>
      </section>

      <footer>
        <span>2人対戦・ローカル保存</span>
        <span id="saveStateInfo"></span>
      </footer>
    </main>

    <script>
      window.addEventListener('DOMContentLoaded', () => {
        // ---- 通常デッキ ----
        const TRUTHS = [
          "恋人に隠していることは？",
          "相手の外見で一番魅力的だと思う部分は？",
          "最後に泣いたのはいつ？",
          "来年の誕生日にしたいことは？",
          "子供のころの夢は？",
          "今一番欲しいものは？"
        ];
        const DARES = [
          "相手の耳元で秘密をささやく",
          "5分間敬語禁止（相手の名前を呼び捨てにする）",
          "5秒間キス顔をする",
          "相手の手の甲に指でハートを描く",
          "相手に褒め言葉を3つ言う"
        ];

        // ---- 裏モードデッキ ----
        const SECRET_TRUTHS = [
          "体の部位で一番のコンプレックスは？",
          "相手と一緒にしたいことは？",
          "浮気をしたことはある？",
          "経験人数は？"
        ];
        const SECRET_DARES = [
          "次の自分の順番まで相手の手を握る",
          "10秒間くすぐられる",
          "相手の指示に従ってお酒を飲む"
        ];

        // ---- 永続化 ----
        const KEY = "tod_state_v5";
        function saveState(state) {
          try { localStorage.setItem(KEY, JSON.stringify(state));
            const info = document.getElementById('saveStateInfo');
            if (info){ info.textContent = "保存中"; setTimeout(()=> info.textContent = "", 600); }
          } catch (_) {}
        }
        function loadState() { try { return JSON.parse(localStorage.getItem(KEY)) || null; } catch { return null; } }

        // ---- 状態 ----
        let deck = [];
        let history = [];
        let players = ["プレイヤー1", "プレイヤー2"];
        let turn = 0;
        let started = false;
        let secretMode = false;

        // ---- 要素 ----
        const el = {
          setup: document.getElementById('setup'),
          game: document.getElementById('game'),
          counts: document.getElementById('counts'),
          typeChip: document.getElementById('typeChip'),
          prompt: document.getElementById('prompt'),
          history: document.getElementById('history'),
          currentPlayer: document.getElementById('currentPlayer'),
          p1: document.getElementById('p1'),
          p2: document.getElementById('p2'),
          btnStart: document.getElementById('btnStart'),
          btnTruth: document.getElementById('btnTruth'),
          btnDare: document.getElementById('btnDare'),
          btnSkip: document.getElementById('btnSkip'),
          btnReset: document.getElementById('btnReset'),
          turnInfo: document.getElementById('turnInfo'),
          btnSecret: document.getElementById('btnSecret')
        };

        // ---- 関数 ----
        function makeDeck() {
          const truths = (secretMode ? SECRET_TRUTHS : TRUTHS).map(t => ({ type: 'truth', text: t }));
          const dares  = (secretMode ? SECRET_DARES  : DARES ).map(t => ({ type: 'dare', text: t }));
          return [...truths, ...dares];
        }
        function shuffle(array) { for (let i=array.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [array[i],array[j]]=[array[j],array[i]];} return array; }
        function counts() {
          const leftAll = deck.length;
          const leftTruth = deck.filter(c=>c.type==='truth').length;
          const leftDare = deck.filter(c=>c.type==='dare').length;
          return { leftAll, leftTruth, leftDare };
        }
        function updateCounts() {
          const { leftAll, leftTruth, leftDare } = counts();
          el.counts.textContent = `残り: ${leftAll}（T:${leftTruth} / D:${leftDare})`;
        }
        function updateCurrentPlayer() {
          if (!started) {
            el.currentPlayer.textContent = '';
            el.turnInfo.textContent = '名前を入力して「開始」';
            document.getElementById('nextHint').textContent = '';
            return;
          }
          const currentIdx = turn;
          const nextIdx = 1 - turn;
          el.currentPlayer.textContent = `現在: ${players[currentIdx]}`;
          el.turnInfo.textContent = `ターン: ${players[currentIdx]}`;
          document.getElementById('nextHint').textContent = `次は ${players[nextIdx]} の番です。「真実」か「挑戦」を選んでください`;
        }
        function render(card) {
          if (!card) {
            el.typeChip.className='chip';
            el.typeChip.textContent='カード未選択';
            el.prompt.textContent='プレイヤーが「真実」か「挑戦」を選んでください';
          } else {
            el.typeChip.className = 'chip ' + (card.type==='truth'?'truth':'dare');
            el.typeChip.textContent = card.type==='truth'?'真実':'挑戦';
            el.prompt.textContent = card.text;
          }
          el.history.innerHTML = history.map(item => `
            <div class="history-item">
              <span class="dot ${item.type}"></span>
              <span>${item.player}</span>
              <span>${item.text}</span>
            </div>`).join('');
          updateCounts();
          updateCurrentPlayer();
        }
        function takeRandom(type) {
          const pool = deck.filter(c=>c.type===type);
          if (pool.length===0) return null;
          const idx = Math.floor(Math.random()*pool.length);
          const card = pool[idx];
          deck.splice(deck.indexOf(card),1);
          return card;
        }
        function drawBy(type) {
          if (!started) return;
          const card = takeRandom(type);
          if (!card) { flashPrompt(type==='truth'?'真実が尽きました':'挑戦が尽きました'); return; }
          history.unshift({ player: players[turn], type: card.type, text: card.text });
          if (navigator.vibrate) navigator.vibrate(8);
          turn = 1 - turn;
          render(card);
          persist();
        }
        function skip() { if (!started) return; if (navigator.vibrate) navigator.vibrate([2,30,2]); turn = 1 - turn; render(null); persist(); }
        function reset(keepPlayers=true) {
          deck = shuffle(makeDeck()); history = [];
          if (!keepPlayers) { players=["プレイヤー1","プレイヤー2"]; turn=0; started=false; el.setup.style.display='grid'; el.game.style.display='none'; }
          render(null); persist();
        }
        function flashPrompt(msg) {
          const old = el.prompt.textContent; el.prompt.textContent = msg; setTimeout(()=> el.prompt.textContent = old, 1200);
        }
        function persist() { saveState({ deck, history, players, turn, started, secretMode }); }
        function restore() {
          const saved = loadState();
          if (saved && Array.isArray(saved.deck) && Array.isArray(saved.history)) {
            ({ deck, history, players, turn, started, secretMode = false } = Object.assign({ players, turn, started:false }, saved));
          } else { deck = shuffle(makeDeck()); started = false; secretMode = false; }
          el.setup.style.display = started ? 'none' : 'grid';
          el.game.style.display = started ? 'block' : 'none';
          el.btnSecret.textContent = secretMode ? "裏モードON" : "裏モードOFF";
          render(null);
        }

        // ---- イベント ----
        el.btnTruth.addEventListener('click', () => drawBy('truth'));
        el.btnDare.addEventListener('click', () => drawBy('dare'));
        el.btnSkip.addEventListener('click', skip);
        el.btnReset.addEventListener('click', () => reset(true));
        el.btnStart.addEventListener('click', () => {
          const n1 = (el.p1.value || '').trim() || 'プレイヤー1';
          const n2 = (el.p2.value || '').trim() || 'プレイヤー2';
          players = [n1, n2]; turn = 0; started = true;
          el.setup.style.display='none'; el.game.style.display='block';
          render(null); persist();
        });

        // ---- 裏モード切替 ----
        el.btnSecret.addEventListener('click', () => {
          secretMode = !secretMode;
          el.btnSecret.textContent = secretMode ? "裏モードON" : "裏モードOFF";
          reset(true);
          persist();
        });

        // ---- 起動 ----
        restore();
      });
    </script>
  </body>
</html>
